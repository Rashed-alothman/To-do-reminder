{% extends 'base.html' %}

{% block title %}Dashboard - Task Master{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <h1 class="card-title">My Tasks</h1>
    <p class="card-subtitle">Stay organized and focused on what matters</p>
  </div>

  <!-- Stats Bar -->
  <div class="stats-bar">
    <div class="stat-item">
      <div class="stat-value" id="total-count">0</div>
      <div class="stat-label">Total Tasks</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="pending-count">0</div>
      <div class="stat-label">Pending</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="completed-count">0</div>
      <div class="stat-label">Completed</div>
    </div>
  </div>

  <!-- Alert Area -->
  <div id="alert-container"></div>

  <!-- Add Task Form -->
  <div class="task-input-group">
    <input 
      type="text" 
      id="task-input" 
      placeholder="What needs to be done?" 
      autocomplete="off"
      autofocus
    >
    <button class="btn primary" id="add-btn" type="button">
      <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path d="M12 4v16m8-8H4"></path>
      </svg>
      Add
    </button>
  </div>

  <!-- Task List -->
  <div id="task-container">
    <div class="empty-state">
      <svg class="empty-state-icon" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <h3 class="empty-state-title">No tasks yet</h3>
      <p class="empty-state-text">Add a task above to get started!</p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const API_BASE = '/homepage/api/tasks';

const taskInput = document.getElementById('task-input');
const addBtn = document.getElementById('add-btn');
const taskContainer = document.getElementById('task-container');
const alertContainer = document.getElementById('alert-container');

// Task counters
const totalCount = document.getElementById('total-count');
const pendingCount = document.getElementById('pending-count');
const completedCount = document.getElementById('completed-count');

let tasks = [];

// Load tasks on page load
document.addEventListener('DOMContentLoaded', loadTasks);

// Add task on button click
addBtn.addEventListener('click', addTask);

// Add task on Enter key
taskInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') addTask();
});

async function loadTasks() {
  try {
    const response = await fetch(`${API_BASE}`);
    const data = await response.json();
    tasks = data.Tasks || [];
    renderTasks();
    updateStats();
  } catch (error) {
    showAlert('Failed to load tasks', 'error');
  }
}

async function addTask() {
  const description = taskInput.value.trim();
  
  if (!description) {
    showAlert('Please enter a task description', 'warning');
    taskInput.focus();
    return;
  }

  if (description.length > 255) {
    showAlert('Task description is too long (max 255 characters)', 'warning');
    return;
  }

  try {
    addBtn.disabled = true;
    const response = await fetch(`${API_BASE}/add_Tasks`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ description })
    });

    if (!response.ok) {
      throw new Error('Failed to add task');
    }

    const data = await response.json();
    tasks.push(data.task);
    taskInput.value = '';
    renderTasks();
    updateStats();
    showAlert('Task added successfully!', 'success');
    taskInput.focus();
  } catch (error) {
    showAlert('Error adding task', 'error');
  } finally {
    addBtn.disabled = false;
  }
}

async function toggleTask(taskId) {
  const task = tasks.find(t => t.id === taskId);
  if (!task) return;

  try {
    const response = await fetch(`${API_BASE}/updated_task`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        id: taskId,
        completed: !task.completed
      })
    });

    if (!response.ok) {
      throw new Error('Failed to update task');
    }

    task.completed = !task.completed;
    renderTasks();
    updateStats();
  } catch (error) {
    showAlert('Error updating task', 'error');
  }
}

async function deleteTask(taskId) {
  if (!confirm('Are you sure you want to delete this task?')) return;

  try {
    const response = await fetch(`${API_BASE}/delete_task`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ id: taskId })
    });

    if (!response.ok) {
      throw new Error('Failed to delete task');
    }

    tasks = tasks.filter(t => t.id !== taskId);
    renderTasks();
    updateStats();
    showAlert('Task deleted', 'success');
  } catch (error) {
    showAlert('Error deleting task', 'error');
  }
}

function renderTasks() {
  if (tasks.length === 0) {
    taskContainer.innerHTML = `
      <div class="empty-state">
        <svg class="empty-state-icon" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h3 class="empty-state-title">No tasks yet</h3>
        <p class="empty-state-text">Add a task above to get started!</p>
      </div>
    `;
    return;
  }

  const taskList = document.createElement('div');
  taskList.className = 'task-list';

  tasks.forEach(task => {
    const taskEl = document.createElement('div');
    taskEl.className = `task-item ${task.completed ? 'completed' : ''}`;
    
    taskEl.innerHTML = `
      <div class="task-content">
        <div class="task-checkbox">
          <input 
            type="checkbox" 
            ${task.completed ? 'checked' : ''}
            onchange="toggleTask('${task.id}')"
          >
          <svg fill="currentColor" viewBox="0 0 24 24" style="position: absolute; width: 12px; height: 12px; pointer-events: none;">
            <path d="M20 6L9 17l-5-5"></path>
          </svg>
        </div>
        <span class="task-text">${escapeHtml(task.description)}</span>
      </div>
      <div class="task-actions">
        <button class="btn danger small" onclick="deleteTask('${task.id}')" title="Delete task">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
        </button>
      </div>
    `;
    
    taskList.appendChild(taskEl);
  });

  taskContainer.innerHTML = '';
  taskContainer.appendChild(taskList);
}

function updateStats() {
  const total = tasks.length;
  const completed = tasks.filter(t => t.completed).length;
  const pending = total - completed;

  totalCount.textContent = total;
  completedCount.textContent = completed;
  pendingCount.textContent = pending;
}

function showAlert(message, type = 'info') {
  const alert = document.createElement('div');
  alert.className = `alert ${type}`;
  
  const iconSvg = {
    success: '<path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>',
    error: '<path d="M12 8v4m0 4v.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>',
    warning: '<path d="M12 9v2m0 4v2m1-17H11a2 2 0 00-2 2v2H6a2 2 0 00-2 2v11a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2z"></path>',
    info: '<path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
  };

  alert.innerHTML = `
    <svg class="alert-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      ${iconSvg[type]}
    </svg>
    <span>${message}</span>
  `;

  alertContainer.appendChild(alert);

  // Auto remove after 4 seconds
  setTimeout(() => {
    alert.style.animation = 'fadeOut 0.3s ease-out';
    setTimeout(() => alert.remove(), 300);
  }, 4000);
}

function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}

// Add fade out animation
const style = document.createElement('style');
style.textContent = `
  @keyframes fadeOut {
    to {
      opacity: 0;
      transform: translateY(-10px);
    }
  }
`;
document.head.appendChild(style);
</script>
{% endblock %}